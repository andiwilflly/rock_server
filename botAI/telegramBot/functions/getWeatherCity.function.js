const randomAnswer = require('./randomAnswer.function');
const fetch = require("node-fetch");
const WIKI = require('wikijs').default;


module.exports = async function getWeatherCity(city, timeMs, isFeature = false) {
    const wikiAPI = await WIKI({ apiUrl: 'https://ru.wikipedia.org/w/api.php' });
    const page = await wikiAPI.find(city);

    const { lat, lon } = await page.coordinates();

    let result = await fetch(`http://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&lang=ru&units=metric&appid=e0ec6da3ca0381df4cc5564f7053ca85`)
    result = await result.json();

    const dayNumber = new Date(timeMs).getDate();
    const hourly = result.hourly.filter(hour => hour.dt *1000 > Date.now() && dayNumber === new Date(hour.dt *1000).getDate());
    const daily = result.daily.filter(day => new Date(day.dt * 1000).getDay() === new Date(timeMs).getDay())[0];

    if(isFeature) {
        const pressure = Math.round(daily.pressure / 133.3224) * 100; // Pa -> –º–º. —Ä—Ç. —Å—Ç.
        return `
üè† ${page.raw.title} (${daily.weather[0].description}, ${daily.rain ? 'üå® —Å–Ω–µ–≥' : daily.snow ? 'üåß –¥–æ–∂–¥—å' : '–±–µ–∑ –æ—Å–∞–¥–∫–æ–≤'})
üìÖ  ${new Date(timeMs).toLocaleDateString()}
üå° –£—Ç—Ä–æ  ${Math.round(daily.temp.morn)}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è ${Math.round(daily.feels_like.morn)}¬∞C)
üå° –î–µ–Ω—å  ${Math.round(daily.temp.day)}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è ${Math.round(daily.feels_like.day)}¬∞C)
üå° –í–µ—á–µ—Ä ${Math.round(daily.temp.eve)}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è ${Math.round(daily.feels_like.eve)}¬∞C)
üå° –ù–æ—á—å  ${Math.round(daily.temp.night)}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è ${Math.round(daily.feels_like.night)}¬∞C)   
üå™ ${Math.round(daily.wind_speed)} –º–µ—Ç—Ä–∞ –≤ —Å–µ–∫—É–Ω–¥—É         
üå´ –î–∞–≤–ª–µ–Ω–∏–µ:   ${pressure} –º–º. —Ä—Ç. —Å—Ç.
üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å:  ${daily.humidity }%
üå• –û–±–ª–∞—á–Ω–æ—Å—Ç—å: ${daily.clouds}%

üßê ${randomAnswer(getWeatherJokes(daily))}`
}

    const pressure = Math.round(result.current.pressure / 133.3224) * 100; // Pa -> –º–º. —Ä—Ç. —Å—Ç.
    return `
üè† ${page.raw.title} (${result.current.weather[0].description}, ${result.current.rain ? 'üå® —Å–Ω–µ–≥' : result.current.snow ? 'üåß –¥–æ–∂–¥—å' : '–±–µ–∑ –æ—Å–∞–¥–∫–æ–≤'})
üå° ${Math.round(result.current.temp)}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è ${Math.round(result.current.feels_like)}¬∞C)
üå™ ${Math.round(result.current.wind_speed)} –º–µ—Ç—Ä–∞ –≤ —Å–µ–∫—É–Ω–¥—É
üå´ –î–∞–≤–ª–µ–Ω–∏–µ:   ${pressure} –º–º. —Ä—Ç. —Å—Ç.
üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å:  ${result.current.humidity }%
üå• –û–±–ª–∞—á–Ω–æ—Å—Ç—å: ${result.current.clouds}% 
    
ü§î ${randomAnswer(getWeatherJokes(result.current))}`;
}

// ${hourly.map(hour => {
//     return `${new Date(hour.dt * 1000).toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: false })} üå° ${Math.round(hour.temp)}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è ${Math.round(hour.feels_like)}¬∞C)`
// }).join('')}

const getWeatherJokes = function(weather) {
    if(weather.snow) return snow;
    if(weather.rain) return rain;

    const temp = weather.temp || weather.temp.max;
    if(+temp > 27) return hot;
    if(+temp < -5) return cold;

    if(+weather.wind_speed >= 15) return bad;
    if(+weather.clouds >= 80) return bad;

    return good;
}

const good = [
    '–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ –≤ –ø—Ä–æ–≥–Ω–æ–∑–µ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞ –ø–æ–≥–æ–¥–æ–π.',
    '–°–∏–Ω–æ–ø—Ç–∏–∫–∏ –æ—à–∏–±–∞—é—Ç—Å—è –ª–∏—à—å –æ–¥–∏–Ω —Ä–∞–∑. –ù–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å',
    '–¢–∞–∫–∞—è —Ö–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞, –Ω–∞–¥–æ –ø–æ–¥–≤–∏–Ω—É—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä –±–ª–∏–∂–µ –∫ –æ–∫–Ω—É.',
    '–ù–µ –±—ã–≤–∞–µ—Ç –ø–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥—ã, –±—ã–≤–∞–µ—Ç –ø–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.',
    '–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –º–µ–Ω—è–µ—Ç—Å—è –ø–æ–≥–æ–¥–∞! –ù–µ —É—Å–ø–µ–µ—à—å –∑–∞—Ö–æ—Ç–µ—Ç—å –æ–¥–Ω—É –æ–¥–µ–∂–¥—É, –∫–∞–∫ —É–∂–µ –ø–æ—Ä–∞ —Ö–æ—Ç–µ—Ç—å –¥—Ä—É–≥—É—é...',
    '–•–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞ –∫–æ –º–Ω–æ–≥–æ–º—É –æ–±—è–∑—ã–≤–∞–µ—Ç. –ù–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–æ–±—â–∞—Ç—å –≤—Å–µ–º, —á—Ç–æ –ø–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è.',
]

const bad = [
    '–ö–∞–∫ –∂–µ —Ç–∞–∫ –Ω–∞–∑–≤–∞—Ç—å —ç—Ç—É –ø–æ–≥–æ–¥—É, –¥–∞ —Ç–∞–∫, —á—Ç–æ–± –Ω–µ –æ–±–∏–¥–µ—Ç—å –º–∞—Ç—É—à–∫—É-–ø—Ä–∏—Ä–æ–¥—É.',
    '–£ –ø—Ä–∏—Ä–æ–¥—ã –Ω–µ—Ç –ø–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥—ã. –î–∞ –∏ —Ö–æ—Ä–æ—à–µ–π —á—Ç–æ-—Ç–æ –¥–∞–≤–Ω–æ –Ω–µ –±—ã–ª–æ...',
    '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –æ—Ç–ø—É—Å–∫–µ –ø–ª–æ—Ö–∞—è –ø–æ–≥–æ–¥–∞ –±—ã–≤–∞–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ',
    '–°–∞–º–∏ –≤—ã –ø–ª–æ—Ö–∏–µ! (—Å) –ü–æ–≥–æ–¥–∞.',
    '–ü–æ–≥–æ–¥–∞ –≤–æ–¥–∫–µ –Ω–µ –ø–æ–º–µ—Ö–∞.',
    '–í—Å–µ —Ç–∞–∫ –∂–∞–ª—É—é—Ç—Å—è –Ω–∞ –ø–æ–≥–æ–¥—É. –ö–∞–∫ –±—É–¥—Ç–æ –∫—Ä–æ–º–µ –ø–æ–≥–æ–¥—ã —É –≤–∞—Å –≤—Å—ë —Ö–æ—Ä–æ—à–æ.',
    '–ü–æ—Å–º–æ—Ç—Ä–µ–ª–∞ –ø–æ–≥–æ–¥—É ‚Äî ¬´—è—Å–Ω–æ¬ª. –í—ã—à–ª–∞ –Ω–∞ —É–ª–∏—Ü—É ‚Äî ¬´–ø–æ–Ω—è—Ç–Ω–æ¬ª...',
    '–ü–æ–≥–æ–¥–∞ ‚Äî —ç—Ç–æ –≥–æ—Ä–¥–∞—è —Å—Ç–µ—Ä–≤–∞‚Ä¶ –ï–π –≤—Å—ë-—Ä–∞–≤–Ω–æ, —á—Ç–æ –æ–Ω–∞ –≤–∞–º –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è‚Ä¶'
]

const hot = [
    '–í—ã —Ç–∞–∫ –Ω–∞–∫—Ä–∞—Å–∏–ª–∏—Å—å... –í–∞–º –Ω–µ –∂–∞—Ä–∫–æ?!',
    '–¢—ã –ø–æ—Å–º–æ—Ç—Ä–∏, –∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –Ω–∞ —É–ª–∏—Ü–µ! –°–æ–ª–Ω—Ü–µ, —Ç–µ–ø–ª–æ, –≤–µ—Å–Ω–æ–π –ø–∞—Ö–Ω–µ—Ç! –î–∞–≤–∞–π —Å—Ö–æ–¥–∏–º –∫—É–¥–∞-–Ω–∏–±—É–¥—å –≤ –ø–∏–≤–±–∞—Ä!',
    '–í—Ä–∞—á–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç –º–Ω–æ–≥–æ –ø–∏—Ç—å. –í–æ—Ç –¥–∞–∂–µ –≤–æ–∑—Ä–∞–∑–∏—Ç—å –∏–º –Ω–µ—á–µ–≥–æ‚Ä¶',
    '–ß–µ–º —Å–∏–ª—å–Ω–µ–µ –ª–µ—Ç–Ω—è—è –∂–∞—Ä–∞, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ —Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ–≤—É—à–∫–∞–º –≤ –≥–ª–∞–∑–∞',
    '–ñ–∞—Ä–∫–æ - —ç—Ç–æ –∫–æ–≥–¥–∞ —Ö–æ—á–µ—à—å –≤–∫–ª—é—áu—Ç—å –∫–æ–Ω–¥–∏—Üuo–Ω–µ—Ä, –∞ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –æ–Ω —É–∂–µ –≤–∫–ª—é—á–µ–Ω',
    '–°–∏–Ω–æ–ø—Ç–∏–∫–∏ –æ—à–∏–±–∞—é—Ç—Å—è –ª–∏—à—å –æ–¥–∏–Ω —Ä–∞–∑. –ù–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å',
    '- –°–æ–ª–Ω—Ü–µ, –∂–∞—Ä–∞, –≤–æ–¥–∞, –ø–µ—Å–æ–∫, —á—Ç–æ –µ—â–µ –Ω—É–∂–Ω–æ?\n' +
    '- –¶–µ–º–µ–Ω—Ç!',
];
const cold = [
    '–ö–æ—Ä–æ—Ç–∫–æ –æ –ø–æ–≥–æ–¥–µ: "–î—É–±–∞–∫", –≥–æ—Å–ø–æ–¥–∞.',
    '–ü—Ä–∏—á–∏–Ω–∞ —Ö–æ–ª–æ–¥–Ω–æ–π –ø–æ–≥–æ–¥—ã - –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–µ.',
    '–ö–æ—Ä–æ—Ç–∫–æ –æ –ø–æ–≥–æ–¥–µ: –±—Ä-—Ä-—Ä-—Ä‚Ä¶',
    '–í —Ç–∞–∫—É—é –ø–æ–≥–æ–¥—É –º–Ω–µ –ø—Ä–æ—Å—Ço –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ —Ç—ë–ø–ª–∞—è –∏ —Ç–æ–ª—Å—Ç–∞—è –¥–µ–≤—É—à–∫–∞',
    '–ü—Ä–æ–≥–Ω–æ–∑—ã –ø–æ–≥–æ–¥—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—à–∏–±–∞—é—Ç—Å—è, –æ–Ω–∏ —Ç–æ–ª—å–∫–æ –ø—É—Ç–∞—é—Ç –≤—Ä–µ–º—è –∏ –º–µ—Å—Ç–æ.',
    '–ü–æ—Ö–æ–¥—É —ç—Ç–æ–π –∑–∏–º–æ–π –º—ã –±—É–¥–µ–º –∫–∏–¥–∞—Ç—å—Å—è –∞—Å—Ñ–∞–ª—å—Ç–æ–º..',
    '–î–æ–ª–±–∞–Ω–Ω—ã–µ —Ö–æ–ª–æ–¥–∞. –°–∫–æ—Ä–µ–µ –±—ã –∂–∞—Ä–∞ –¥–æ–ª–±–∞–Ω–Ω–∞—è',
    '–ë–æ–≥ —Ç–æ–∂–µ –ª—é–±–∏—Ç —é–º–æ—Ä. –û—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã.',
    '–°–µ–≥–æ–¥–Ω—è —Ç–∞–∫–∞—è –ø–æ–≥–æ–¥–∞, —á—Ç–æ —Å–∏–∂—É –∏ –¥—É–º–∞—é: –∞ —á—Ç–æ –µ—Å–ª–∏ –≥–ª–∏–Ω—Ç–≤–µ–π–Ω —Å–¥–µ–ª–∞—Ç—å –Ω–∞ –≤–æ–¥–∫–µ?..',
];

const rain = [
    '–®–∞–º–∞–Ω –±—ã –∑–∞ —Ç–∞–∫—É—é –ø–æ–≥–æ–¥—É –ø–æ–ª—É—á–∏–ª –±—ã –≤ –±—É–±–µ–Ω.',
    '–ò –µ—â–µ –æ –ø–æ–≥–æ–¥–µ. –ê –Ω–µ –ø–æ—Ä–∞ –ª–∏ –Ω–∞–º —Å—Ç—Ä–æ–∏—Ç—å –∫–æ–≤—á–µ–≥??',
    '–û–¥–Ω–∏ –ª—é–¥–∏ –≥—É–ª—è—é—Ç –ø–æ–¥ –¥–æ–∂–¥–µ–º, –¥—Ä—É–≥–∏–µ –º–æ–∫–Ω—É—Ç.',
    '–ó–æ–Ω—Ç ‚Äî –≤–µ—â—å, –∫–æ—Ç–æ—Ä—É—é –Ω–∞–¥–æ –±—Ä–∞—Ç—å —Å —Å–æ–±–æ–π, —á—Ç–æ–±—ã –Ω–µ –ø–æ—à–µ–ª –¥–æ–∂–¥—å.',
    '–°–µ–≥–æ–¥–Ω—è —Ç–∞–∫–∞—è –ø–æ–≥–æ–¥–∞, —á—Ç–æ –∑–∞–ø—Ä–∞–≤–ª—è—Ç—å –∫—Ä–æ–≤–∞—Ç—å –≤–æ–æ–±—â–µ –Ω–µ—Ç —Å–º—ã—Å–ª–∞....',
    '–ï—Å–ª–∏ –ø–æ–≥–æ–¥–∞ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è, —Ç–æ —ç—Ç–∏–º –ª–µ—Ç–æ–º –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –Ω–µ –∑–∞–≥–æ—Ä–µ—Ç—å, –∞ –∑–∞—Ä–∂–∞–≤–µ—Ç—å.'
];

const snow = [
    '–ù–∞—á–∞–ª—Å—è —Å–µ–∑–æ–Ω "–∫—Ç–æ —Ä–∞–Ω–æ –≤—Å—Ç–∞—ë—Ç, —Ç–æ—Ç —Å–Ω–µ–≥ –±–æ–ª—å—à–æ–π –ª–æ–ø–∞—Ç–æ–π –≥—Ä–µ–±—ë—Ç".',
    '–°–µ–≥–æ–¥–Ω—è —Ç–∞–∫–∞—è –ø–æ–≥–æ–¥–∞, —á—Ç–æ –∑–∞–ø—Ä–∞–≤–ª—è—Ç—å –∫—Ä–æ–≤–∞—Ç—å –≤–æ–æ–±—â–µ –Ω–µ—Ç —Å–º—ã—Å–ª–∞...',
    '–ù–∞ —É–ª–∏—Ü–µ —Ç–∞–∫–∞—è –ø–æ–≥–æ–¥–∞, —á—Ç–æ –æ–ª–∏–≤—å–µ –∑–∞—Ö–æ—Ç–µ–ª–æ—Å—å',
];